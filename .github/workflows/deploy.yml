name: "Deploy through Elastic Beanstalk"

on:
  pull_request:
    branches: ["main"]

permissions:
  id-token: write
  contents: read

jobs:
  build:
    name: "Build and Deploy"
    runs-on: ubuntu-latest

    steps:
      - name: "Checkout Code"
        uses: actions/checkout@v4

      - name: "Set up Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: "16"

      - name: "Install Dependencies"
        run: npm install

      - name: "Run Tests"
        run: npm test

      - name: "Build Application"
        run: npm run build

      - name: "Create Deployment Package"
        run: zip -r deploy.zip .

      # AWS OIDC â€” NO ACCESS KEYS REQUIRED
      - name: "Connect to AWS via OIDC"
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: us-west-2

      # Upload app package to S3
      - name: "Upload to S3"
        run: |
          aws s3 cp deploy.zip s3://${{secrets.AWS_S3_BUCKET}}/deploy-${{ github.run_number }}.zip

      # Create new EB application version
      - name: "Create EB Application Version"
        run: |
          aws elasticbeanstalk create-application-version \
            --application-name ${{ secrets.AWS_EB_APPLICATION_NAME }} \
            --version-label v-${{ github.run_number }} \
            --source-bundle S3Bucket="${{ secrets.AWS_S3_BUCKET }}",S3Key="deploy-${{ github.run_number }}.zip"

      # Deploy that version to your environment
      - name: "Deploy to Elastic Beanstalk"
        run: |
          aws elasticbeanstalk update-environment \
            --environment-name ${{ secrets.AWS_EB_ENVIRONMENT_NAME }} \
            --version-label v-${{ github.run_number }}
